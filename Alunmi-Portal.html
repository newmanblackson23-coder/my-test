<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alumni Portal — Dashboard + Admin Panel</title>

<!-- Firebase compat libs (simple integration) -->
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-storage-compat.js"></script>

<style>
  :root{--accent:#2563eb;--muted:#6b7280}
  body{font-family:Inter,system-ui,Arial;margin:0;background:#f3f4f6;color:#0f1724}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;box-shadow:0 2px 8px rgba(15,23,36,.06)}
  .brand{font-weight:700;color:var(--accent)}
  main{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,.05)}
  .box-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:70vh}
  input,textarea,select{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;margin-top:8px}
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(37,99,235,.12);color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .list{margin-top:8px}
  .list-item{padding:10px;border-radius:8px;border:1px solid #eef2ff;margin-bottom:8px}
  .row{display:flex;gap:8px;align-items:center}
  .admin-only{display:none}
  .gallery img{max-width:120px;border-radius:8px;margin:6px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:40}
  .modal .panel{background:#fff;padding:16px;border-radius:10px;min-width:320px}
  .muted{color:var(--muted)}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div class="brand">Alumni Portal</div>
  <div id="headerRight" class="row small">
    <div id="signedInAs">Not signed in</div>
    <button id="signOutBtn" class="btn-ghost" style="display:none" onclick="doSignOut()">Sign out</button>
  </div>
</header>

<main>
  <!-- auth area -->
  <div id="authCard" class="card">
    <div id="authForms" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <!-- login -->
      <div>
        <h3>Login</h3>
        <input id="li_email" placeholder="Email" />
        <input id="li_pass" type="password" placeholder="Password" />
        <div class="row" style="margin-top:8px">
          <button onclick="login()">Login</button>
          <button class="btn-ghost" onclick="showSignup()">Signup</button>
        </div>
        <p style="margin-top:8px"><a href="#" onclick="openReset()">Forgot password?</a></p>
        <div id="authMsg" class="small muted"></div>
      </div>

      <!-- signup -->
      <div>
        <h3>Signup</h3>
        <input id="su_email" placeholder="Email" />
        <input id="su_pass" type="password" placeholder="Password (6+ chars)" />
        <input id="su_name" placeholder="Full name (display)" />
        <div style="margin-top:8px"><button onclick="signup()">Create account</button></div>
        <div class="small muted" style="margin-top:8px">Admin: <strong>newmanblackson23@gmail.com</strong></div>
      </div>
    </div>
  </div>

  <!-- app UI -->
  <div id="appUI" style="display:none" class="grid">
    <section>
      <div class="card">
        <h2>Welcome</h2>
        <p class="small">Shared alumni space — events, announcements, support, memories.</p>
      </div>

      <div class="card">
        <h3>Events</h3>
        <div id="eventsList" class="list"></div>
      </div>

      <div class="card">
        <h3>Announcements</h3>
        <div id="annList" class="list"></div>
      </div>

      <div class="card">
        <h3>Support Corner</h3>
        <div id="supportList" class="list"></div>
      </div>

      <div class="card">
        <h3>Memories</h3>
        <div id="memoriesGallery" class="gallery"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>Members</h3>
        <input id="searchMember" placeholder="Search member name" oninput="renderMembersFiltered()" />
        <div id="membersList" style="margin-top:8px;max-height:360px;overflow:auto"></div>
      </div>

      <!-- Admin Panel inside dashboard (hidden unless admin) -->
      <div id="adminPanel" class="card admin-only">
        <h3>Admin Panel</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button onclick="openAdminModal('events')">Manage Events</button>
          <button onclick="openAdminModal('announcements')">Manage Announcements</button>
          <button onclick="openAdminModal('support')">Manage Support</button>
          <button onclick="openAdminModal('memories')">Manage Memories</button>
          <button onclick="openAdminModal('members')">Manage Members</button>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- reset modal -->
<div id="resetModal" class="modal" style="display:none">
  <div class="panel">
    <h4>Reset password</h4>
    <input id="reset_email" placeholder="Enter your email" />
    <div style="margin-top:8px" class="row">
      <button onclick="sendReset()">Send Reset Email</button>
      <button class="btn-ghost" onclick="closeReset()">Cancel</button>
    </div>
    <div id="resetMsg" class="small" style="margin-top:8px"></div>
  </div>
</div>

<!-- admin modal root -->
<div id="modalRoot" style="display:none"></div>

<script>
/* ==========================
   CONFIG - paste your config
   ========================== */
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDKy1At6EhaWhLBVv3hocPky5JqGSKcjpo",
  authDomain: "my-test-94983.firebaseapp.com",
  projectId: "my-test-94983",
  storageBucket: "my-test-94983.firebasestorage.app",
  messagingSenderId: "499747677665",
  appId: "1:499747677665:web:3ae6f8df04594b9697dea0"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
/* -------------------------- */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const ADMIN_EMAIL = "newmanblackson23@gmail.com";

// UI refs
const authCard = document.getElementById('authCard');
const appUI = document.getElementById('appUI');
const signedInAs = document.getElementById('signedInAs');
const signOutBtn = document.getElementById('signOutBtn');
const adminPanel = document.getElementById('adminPanel');
const modalRoot = document.getElementById('modalRoot');

let unsub = []; // listeners

/* ===== Auth functions ===== */
async function signup(){
  const email = document.getElementById('su_email').value.trim();
  const pass = document.getElementById('su_pass').value;
  const name = document.getElementById('su_name').value.trim() || email.split('@')[0];
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    // create member profile
    await db.collection('members').doc(cred.user.uid).set({
      uid: cred.user.uid, email, name, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Account created — please login');
    document.getElementById('su_email').value='';
    document.getElementById('su_pass').value='';
    document.getElementById('su_name').value='';
  } catch(e){
    setAuthMsg(e.message);
  }
}

async function login(){
  const email = document.getElementById('li_email').value.trim();
  const pass = document.getElementById('li_pass').value;
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    setAuthMsg('');
  } catch(e){
    setAuthMsg(e.message);
  }
}

function showSignup(){
  const cards = document.querySelectorAll('#authForms > div');
  cards[0].style.display = 'none'; cards[1].style.display = 'block';
}
function showLogin(){
  const cards = document.querySelectorAll('#authForms > div');
  cards[0].style.display = 'block'; cards[1].style.display = 'none';
}

function setAuthMsg(txt){ document.getElementById('authMsg').innerText = txt || ''; }

function openReset(){ document.getElementById('resetModal').style.display='flex'; }
function closeReset(){ document.getElementById('resetModal').style.display='none'; document.getElementById('resetMsg').innerText=''; }

async function sendReset(){
  const e = document.getElementById('reset_email').value.trim();
  try {
    await auth.sendPasswordResetEmail(e);
    document.getElementById('resetMsg').innerText = 'Reset email sent — check inbox.';
  } catch(err){
    document.getElementById('resetMsg').innerText = err.message;
  }
}

function doSignOut(){ auth.signOut(); }

/* ===== Auth state & subscriptions ===== */
auth.onAuthStateChanged(async user=>{
  if(user){
    // UI
    authCard.style.display = 'none';
    appUI.style.display = 'grid';
    document.getElementById('signedInAs').textContent = 'Signed in: ${user.email}';
    signOutBtn.style.display = 'inline-block';

    // show admin panel only for admin
    if(user.email === ADMIN_EMAIL){
      adminPanel.classList.remove('admin-only');
      adminPanel.style.display = 'block';
    } else {
      adminPanel.classList.add('admin-only');
      adminPanel.style.display = 'none';
    }

    // subscribe listeners
    subscribeAll();
  } else {
    // signed out
    authCard.style.display = 'block';
    appUI.style.display = 'none';
    document.getElementById('signedInAs').textContent = 'Not signed in';
    signOutBtn.style.display = 'none';
    // clear listeners
    unsub.forEach(f=>f && f()); unsub=[];
    // clear UI lists
    document.getElementById('eventsList').innerHTML='';
    document.getElementById('annList').innerHTML='';
    document.getElementById('supportList').innerHTML='';
    document.getElementById('memoriesGallery').innerHTML='';
    document.getElementById('membersList').innerHTML='';
  }
});

/* ===== Real-time subscriptions ===== */
function subscribeAll(){
  // events
  const u1 = db.collection('events').orderBy('createdAt','desc').onSnapshot(snap=>{
    const out = document.getElementById('eventsList'); out.innerHTML='';
    snap.forEach(doc=> renderEvent(doc.id, doc.data()));
  });
  unsub.push(u1);

  // announcements
  const u2 = db.collection('announcements').orderBy('createdAt','desc').onSnapshot(snap=>{
    const out = document.getElementById('annList'); out.innerHTML='';
    snap.forEach(doc=> renderAnn(doc.id, doc.data()));
  });
  unsub.push(u2);

  // support
  const u3 = db.collection('support').orderBy('createdAt','desc').onSnapshot(snap=>{
    const out = document.getElementById('supportList'); out.innerHTML='';
    snap.forEach(doc=> renderSupport(doc.id, doc.data()));
  });
  unsub.push(u3);

  // memories
  const u4 = db.collection('memories').orderBy('createdAt','desc').onSnapshot(snap=>{
    const g = document.getElementById('memoriesGallery'); g.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data();
      if(d.url){
        const img = document.createElement('img');
        img.src = d.url; img.alt = d.name||'memory';
        // admin delete option appended below if admin
        const wrapper = document.createElement('div');
        wrapper.style.display='inline-block'; wrapper.style.position='relative';
        wrapper.appendChild(img);
        if(auth.currentUser && auth.currentUser.email === ADMIN_EMAIL){
          const del = document.createElement('button'); del.textContent='🗑'; del.style.position='absolute'; del.style.right='6px'; del.style.top='6px';
          del.onclick = async ()=>{ await storage.ref(d.storagePath).delete().catch(()=>{}); await db.collection('memories').doc(doc.id).delete(); };
          wrapper.appendChild(del);
        }
        g.appendChild(wrapper);
      }
    });
  });
  unsub.push(u4);

  // members
  const u5 = db.collection('members').orderBy('name').onSnapshot(snap=>{
    window.__membersSnap = snap;
    renderMembersFiltered();
  });
  unsub.push(u5);
}

/* ===== renderers ===== */
function renderEvent(id, data){
  const container = document.getElementById('eventsList');
  const div = document.createElement('div'); div.className='list-item';
  div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>${escapeHtml(data.title||data.text||'Untitled')}</strong><div class="small">${escapeHtml(data.date||'')}</div></div>
  </div>`;
  if(auth.currentUser && auth.currentUser.email === ADMIN_EMAIL){
    const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=>openAdminEdit('events', id, data);
    const del = document.createElement('button'); del.textContent='Delete'; del.onclick=()=>db.collection('events').doc(id).delete();
    const r = document.createElement('div'); r.className='row'; r.style.marginTop='8px'; r.appendChild(edit); r.appendChild(del);
    div.appendChild(r);
  }
  container.appendChild(div);
}

function renderAnn(id, data){
  const container = document.getElementById('annList');
  const div = document.createElement('div'); div.className='list-item';
  div.innerHTML = <div><strong>${escapeHtml(data.title||'Announcement')}</strong><p class="small">${escapeHtml(data.text||'')}</p></div>;
  if(auth.currentUser && auth.currentUser.email === ADMIN_EMAIL){
    const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=>openAdminEdit('announcements', id, data);
    const del = document.createElement('button'); del.textContent='Delete'; del.onclick=()=>db.collection('announcements').doc(id).delete();
    const r = document.createElement('div'); r.className='row'; r.appendChild(edit); r.appendChild(del); div.appendChild(r);
  }
  container.appendChild(div);
}

function renderSupport(id, data){
  const container = document.getElementById('supportList');
  const div = document.createElement('div'); div.className='list-item';
  div.innerHTML = <div><strong>${escapeHtml(data.title||'Support')}</strong><p class="small">${escapeHtml(data.text||'')}</p></div>;
  if(auth.currentUser && auth.currentUser.email === ADMIN_EMAIL){
    const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=>openAdminEdit('support', id, data);
    const del = document.createElement('button'); del.textContent='Delete'; del.onclick=()=>db.collection('support').doc(id).delete();
    const r = document.createElement('div'); r.className='row'; r.appendChild(edit); r.appendChild(del); div.appendChild(r);
  }
  container.appendChild(div);
}

/* ===== members list & search ===== */
function renderMembersFiltered(){
  const q = (document.getElementById('searchMember').value || '').toLowerCase();
  const list = document.getElementById('membersList'); list.innerHTML='';
  const snap = window.__membersSnap;
  if(!snap) return;
  snap.forEach(doc=>{
    const d = doc.data();
    const name = (d.name||'').toLowerCase();
    if(!q || name.includes(q) || (d.email||'').toLowerCase().includes(q)){
      const div = document.createElement('div'); div.className='list-item';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escapeHtml(d.name||'')}</strong><div class="small">${escapeHtml(d.email||'')}</div></div>
      </div>`;
      if(auth.currentUser && auth.currentUser.email === ADMIN_EMAIL){
        const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=>openAdminEdit('members', doc.id, d);
        const del = document.createElement('button'); del.textContent='Delete'; del.onclick=()=>db.collection('members').doc(doc.id).delete();
        const r = document.createElement('div'); r.className='row'; r.appendChild(edit); r.appendChild(del); div.appendChild(r);
      }
      list.appendChild(div);
    }
  });
}

/* ===== Admin panel & modal ===== */
function openAdminModal(section){ showModal(buildAdminPanel(section)); }
function openAdminEdit(section,id,data){ showModal(buildAdminPanel(section,id,data)); }

function showModal(html){
  modalRoot.style.display='block';
  modalRoot.innerHTML = <div class="modal" id="adminModal"><div class="panel">${html}<div style="margin-top:10px"><button onclick="closeModal()">Close</button></div></div></div>;
  document.getElementById('adminModal').onclick = (e)=>{ if(e.target.id==='adminModal') closeModal(); };
}
function closeModal(){ modalRoot.style.display='none'; modalRoot.innerHTML=''; }

function buildAdminPanel(section,id=null,data=null){
  let html = <h4>Manage ${escapeHtml(section)}</h4>;
  if(section==='events'){
    html += `<input id="admin_evt_title" placeholder="Title" value="${escapeHtml(data?.title||data?.text||'')}" />
             <input id="admin_evt_date" placeholder="Date (optional)" value="${escapeHtml(data?.date||'')}" />
             <div style="margin-top:8px"><button onclick="adminSave('events','${id||''}')">${id?'Update':'Create'}</button></div>`;
  } else if(section==='announcements'){
    html += `<input id="admin_ann_title" placeholder="Title" value="${escapeHtml(data?.title||'')}" />
             <textarea id="admin_ann_text" placeholder="Text">${escapeHtml(data?.text||'')}</textarea>
             <div style="margin-top:8px"><button onclick="adminSave('announcements','${id||''}')">${id?'Update':'Create'}</button></div>`;
  } else if(section==='support'){
    html += `<input id="admin_sup_title" placeholder="Title" value="${escapeHtml(data?.title||'')}" />
             <textarea id="admin_sup_text" placeholder="Text">${escapeHtml(data?.text||'')}</textarea>
             <div style="margin-top:8px"><button onclick="adminSave('support','${id||''}')">${id?'Update':'Create'}</button></div>`;
  } else if(section==='memories'){
    html += `<input type="file" id="admin_mem_file" accept="image/,video/" />
             <div style="margin-top:8px"><button onclick="adminUploadMemory()">Upload</button></div>`;
    if(id && data && data.url) html += <p>Existing: <a href="${data.url}" target="_blank">view</a></p>;
  } else if(section==='members'){
    html += `<input id="admin_mem_name" placeholder="Name" value="${escapeHtml(data?.name||'')}" />
             <input id="admin_mem_email" placeholder="Email" value="${escapeHtml(data?.email||'')}" />
             <div style="margin-top:8px"><button onclick="adminSave('members','${id||''}')">${id?'Update':'Create'}</button></div>`;
  }
  return html;
}

async function adminSave(section,id){
  if(section==='events'){
    const title = document.getElementById('admin_evt_title').value.trim();
    const date = document.getElementById('admin_evt_date').value.trim();
    if(!title) return alert('Title required');
    if(id) await db.collection('events').doc(id).update({ title, date, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    else await db.collection('events').add({ title, date, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  } else if(section==='announcements'){
    const title = document.getElementById('admin_ann_title').value.trim();
    const text = document.getElementById('admin_ann_text').value.trim();
    if(!text) return alert('Text required');
    if(id) await db.collection('announcements').doc(id).update({ title, text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    else await db.collection('announcements').add({ title, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  } else if(section==='support'){
    const title = document.getElementById('admin_sup_title').value.trim();
    const text = document.getElementById('admin_sup_text').value.trim();
    if(!text) return alert('Text required');
    if(id) await db.collection('support').doc(id).update({ title, text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    else await db.collection('support').add({ title, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  } else if(section==='members'){
    const name = document.getElementById('admin_mem_name').value.trim();
    const email = document.getElementById('admin_mem_email').value.trim();
    if(!name||!email) return alert('Name & email required');
    if(id) await db.collection('members').doc(id).update({ name, email });
    else await db.collection('members').add({ name, email, joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
  }
  closeModal();
}

/* memory upload */
async function adminUploadMemory(){
  const f = document.getElementById('admin_mem_file').files[0];
  if(!f) return alert('Choose a file');
  const path = 'memories/${Date.now()}_${f.name}';
  const ref = storage.ref(path);
  await ref.put(f);
  const url = await ref.getDownloadURL();
  await db.collection('memories').add({ url, name: f.name, storagePath: path, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  alert('Uploaded');
  closeModal();
}

/* ===== utilities ===== */
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
</script>
</body>
</html>